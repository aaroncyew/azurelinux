From 7b12da1a5079128b769ff99e950fa7a92af20aff Mon Sep 17 00:00:00 2001
From: Rohit Rawat <xordux@gmail.com>
Date: Thu, 16 May 2024 12:05:43 +0000
Subject: [PATCH] protobuf-go: Fix CVE-2024-24786

---
 .../protobuf/encoding/protojson/well_known_types.go      | 9 +++++++++
 .../protobuf/internal/encoding/json/decode.go            | 2 +-
 2 files changed, 10 insertions(+), 1 deletion(-)

diff --git a/vendor/google.golang.org/protobuf/encoding/protojson/well_known_types.go b/vendor/google.golang.org/protobuf/encoding/protojson/well_known_types.go
index 72924a9..9384f0b 100644
--- a/vendor/google.golang.org/protobuf/encoding/protojson/well_known_types.go
+++ b/vendor/google.golang.org/protobuf/encoding/protojson/well_known_types.go
@@ -328,6 +328,10 @@ func (d decoder) skipJSONValue() error {
 				if err := d.skipJSONValue(); err != nil {
 					return err
 				}
+			case json.EOF:
+				// This can only happen if there's a bug in Decoder.Read.
+				// Avoid an infinite loop if this does happen.
+				return errors.New("unexpected EOF")
 			}
 		}
 
@@ -341,6 +345,11 @@ func (d decoder) skipJSONValue() error {
 			case json.ArrayClose:
 				d.Read()
 				return nil
+			case json.EOF:
+				// This can only happen if there's a bug in Decoder.Read.
+				// Avoid an infinite loop if this does happen.
+				return errors.New("unexpected EOF")
+			}
 			default:
 				// Skip array item.
 				if err := d.skipJSONValue(); err != nil {
diff --git a/vendor/google.golang.org/protobuf/internal/encoding/json/decode.go b/vendor/google.golang.org/protobuf/internal/encoding/json/decode.go
index b13fd29..b2be4e8 100644
--- a/vendor/google.golang.org/protobuf/internal/encoding/json/decode.go
+++ b/vendor/google.golang.org/protobuf/internal/encoding/json/decode.go
@@ -121,7 +121,7 @@ func (d *Decoder) Read() (Token, error) {
 
 	case ObjectClose:
 		if len(d.openStack) == 0 ||
-			d.lastToken.kind == comma ||
+			d.lastToken.kind&(Name|comma) != 0 ||
 			d.openStack[len(d.openStack)-1] != ObjectOpen {
 			return Token{}, d.newSyntaxError(tok.pos, unexpectedFmt, tok.RawString())
 		}
-- 
2.33.8

