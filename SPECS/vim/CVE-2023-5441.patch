From eaac3ec659cdd1c3451546cc69e3b73e6882641f Mon Sep 17 00:00:00 2001
From: Mykhailo Bykhovtsev <mbykhovtsev@microsoft.com>
Date: Wed, 11 Oct 2023 17:59:56 -0700
Subject: [PATCH] patch CVE-2023-5441

---
 src/gui.c                         | 4 ++++
 src/testdir/crash/crash_scrollbar | 2 ++
 src/testdir/test_crash.vim        | 7 +++++++
 src/version.c                     | 2 ++
 4 files changed, 15 insertions(+)
 create mode 100644 src/testdir/crash/crash_scrollbar

diff --git a/src/gui.c b/src/gui.c
index 1f546b2..6b7758c 100644
--- a/src/gui.c
+++ b/src/gui.c
@@ -4397,6 +4397,7 @@ gui_do_scrollbar(
  * Scroll a window according to the values set in the globals
  * "current_scrollbar" and "scrollbar_value".
  * Return TRUE if the cursor in the current window moved or FALSE otherwise.
+ * may eventually cause a redraw using updateWindow
  */
     int
 gui_do_scroll(void)
@@ -4416,6 +4417,9 @@ gui_do_scroll(void)
     if (wp == NULL)
 	// Couldn't find window
 	return FALSE;
+	// don't redraw, LineOffset and similar are not valid!
+	if (exmode_active)
+		return FALSE;
 
     /*
      * Compute number of lines to scroll.  If zero, nothing to do.
diff --git a/src/testdir/crash/crash_scrollbar b/src/testdir/crash/crash_scrollbar
new file mode 100644
index 0000000..2ed6a11
--- /dev/null
+++ b/src/testdir/crash/crash_scrollbar
@@ -0,0 +1,2 @@
+" this goes to insert mode and presses key k_VerScrollbar which may cause a redraw in exmode, which used ot crash Vim
+norm o��X
\ No newline at end of file
diff --git a/src/testdir/test_crash.vim b/src/testdir/test_crash.vim
index a1da68e..0864494 100644
--- a/src/testdir/test_crash.vim
+++ b/src/testdir/test_crash.vim
@@ -66,6 +66,12 @@ func Test_crash1()
     \ '  && echo "crash 7: [OK]" >> X_crash1_result.txt' .. "\<cr>")
   call TermWait(buf, 3000)
 
+  let file = 'crash/crash_scrollbar'
+  let args = printf(cmn_args, vim, file)
+  call term_sendkeys(buf, args ..
+    \ '  && echo "crash 9: [OK]" >> X_crash1_result.txt' .. "\<cr>")
+  call TermWait(buf, 1000)
+
   " clean up
   exe buf .. "bw!"
 
@@ -79,6 +85,7 @@ func Test_crash1()
       \ 'crash 5: [OK]',
       \ 'crash 6: [OK]',
       \ 'crash 7: [OK]',
+      \ 'crash 9: [OK]',
       \ ]
 
   call assert_equal(expected, getline(1, '$'))
diff --git a/src/version.c b/src/version.c
index aaa50da..a609937 100644
--- a/src/version.c
+++ b/src/version.c
@@ -699,6 +699,8 @@ static char *(features[]) =
 
 static int included_patches[] =
 {   /* Add new patch number below this line */
+/**/
+    1992,
 /**/
     1897,
 /**/
-- 
2.38.0.windows.1

