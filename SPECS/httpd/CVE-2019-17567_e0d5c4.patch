From e0d5c4d8ad98ad6fe17724d4f199327f980f08f2 Mon Sep 17 00:00:00 2001
From: Yann Ylavic <ylavic@apache.org>
Date: Thu, 19 Jul 2018 09:06:37 +0000
Subject: [PATCH] core: follow up to r1836237: whitelist in-memory buckets.

As Eric noted, this is safer w.r.t. third party buckets which could be
uncought by the previous backlist and get out of memory limits.


git-svn-id: https://svn.apache.org/repos/asf/httpd/httpd/trunk@1836258 13f79535-47bb-0310-9956-ffa450edef68
---
 server/core_filters.c | 13 +++++--------
 1 file changed, 5 insertions(+), 8 deletions(-)

diff --git a/server/core_filters.c b/server/core_filters.c
index 7b7fd3da899..77770eb0da9 100644
--- a/server/core_filters.c
+++ b/server/core_filters.c
@@ -604,14 +604,11 @@ static void setaside_remaining_output(ap_filter_t *f,
 
 static APR_INLINE int is_in_memory_bucket(apr_bucket *b)
 {
-    /* The bucket data are already in memory unless:
-     *   - it's a morphing bucket (heap buffers allocated on read), or
-     *   - it's a file bucket (heap buffers also allocated on read), or
-     *   - it's a mmap bucket (mapping happens over memory access usually).
-     */
-    return b->length != (apr_size_t)-1
-           && !APR_BUCKET_IS_FILE(b)
-           && !APR_BUCKET_IS_MMAP(b);
+    /* These buckets' data are already in memory. */
+    return APR_BUCKET_IS_HEAP(b)
+           || APR_BUCKET_IS_POOL(b)
+           || APR_BUCKET_IS_TRANSIENT(b)
+           || APR_BUCKET_IS_IMMORTAL(b);
 }
 
 #if APR_HAS_SENDFILE
