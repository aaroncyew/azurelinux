From e505847728d833d86849ae8c232199f8895d1f2a Mon Sep 17 00:00:00 2001
From: Ruediger Pluem <rpluem@apache.org>
Date: Mon, 15 Oct 2018 19:25:20 +0000
Subject: [PATCH] * Ensure that aborted connections are logged as such.   Set
 c->aborted before apr_brigade_cleanup to have the correct status   when
 logging the request as apr_brigade_cleanup triggers the logging   of the
 request if it contains an EOR bucket.

PR: 62823
Submitted by: Arnaud Grandville <contact@grandville.net>
Reviewed by:rpluem

git-svn-id: https://svn.apache.org/repos/asf/httpd/httpd/trunk@1843939 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES               | 3 +++
 server/core_filters.c | 7 ++++++-
 2 files changed, 9 insertions(+), 1 deletion(-)

diff --git a/CHANGES b/CHANGES
index 64c9711032c..fa0b1a0bf3d 100644
--- a/CHANGES
+++ b/CHANGES
@@ -1,6 +1,9 @@
                                                          -*- coding: utf-8 -*-
 Changes with Apache 2.4.47
 
+  *) core: Ensure that aborted connections are logged as such. PR 62823
+     [Arnaud Grandville <contact@grandville.net>]
+
   *) core: add ReadBufferSize, FlushMaxThreshold and FlushMaxPipelined
      directives.  [Yann Ylavic]
 
diff --git a/server/core_filters.c b/server/core_filters.c
index fce04a1ac8d..7cd49f6df3d 100644
--- a/server/core_filters.c
+++ b/server/core_filters.c
@@ -538,8 +538,13 @@ apr_status_t ap_core_output_filter(ap_filter_t *f, apr_bucket_brigade *new_bb)
         ap_log_cerror(
                 APLOG_MARK, APLOG_TRACE1, rv, c,
                 "core_output_filter: writing data to the network");
-        apr_brigade_cleanup(bb);
+        /*
+         * Set c->aborted before apr_brigade_cleanup to have the correct status
+         * when logging the request as apr_brigade_cleanup triggers the logging
+         * of the request if it contains an EOR bucket.
+         */
         c->aborted = 1;
+        apr_brigade_cleanup(bb);
         return rv;
     }
 
