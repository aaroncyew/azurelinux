From 9367ccb9940c29463d5e4097d1076e6ada89b90e Mon Sep 17 00:00:00 2001
From: Manfred Kaiser <manfred.kaiser@bmlv.gv.at>
Date: Fri, 17 Sep 2021 12:18:14 +0200
Subject: [PATCH] added new client config option PubkeyDisablePKCheck

---
 readconf.c    | 13 +++++++++++--
 readconf.h    |  1 +
 scp.1         |  1 +
 sftp.1        |  1 +
 ssh.1         |  1 +
 ssh_config    |  1 +
 ssh_config.5  |  7 +++++++
 sshconnect2.c |  2 +-
 8 files changed, 24 insertions(+), 3 deletions(-)

diff --git a/readconf.c b/readconf.c
index bcca6ed47c..479931090f 100644
--- a/readconf.c
+++ b/readconf.c
@@ -154,7 +154,7 @@ typedef enum {
 	oBatchMode, oCheckHostIP, oStrictHostKeyChecking, oCompression,
 	oTCPKeepAlive, oNumberOfPasswordPrompts,
 	oLogFacility, oLogLevel, oLogVerbose, oCiphers, oMacs,
-	oPubkeyAuthentication,
+	oPubkeyAuthentication, oPubkeyDisablePKCheck,
 	oKbdInteractiveAuthentication, oKbdInteractiveDevices, oHostKeyAlias,
 	oDynamicForward, oPreferredAuthentications, oHostbasedAuthentication,
 	oHostKeyAlgorithms, oBindAddress, oBindInterface, oPKCS11Provider,
@@ -233,6 +233,7 @@ static struct {
 	{ "skeyauthentication", oKbdInteractiveAuthentication }, /* alias */
 	{ "tisauthentication", oKbdInteractiveAuthentication },  /* alias */
 	{ "pubkeyauthentication", oPubkeyAuthentication },
+	{ "pubkeydisablepkcheck", oPubkeyDisablePKCheck},
 	{ "dsaauthentication", oPubkeyAuthentication },		    /* alias */
 	{ "hostbasedauthentication", oHostbasedAuthentication },
 	{ "identityfile", oIdentityFile },
@@ -1105,6 +1106,10 @@ process_config_line_depth(Options *options, struct passwd *pw, const char *host,
 		intptr = &options->pubkey_authentication;
 		goto parse_flag;
 
+	case oPubkeyDisablePKCheck:
+		intptr = &options->pubkey_disable_pk_check;
+		goto parse_flag;
+
 	case oHostbasedAuthentication:
 		intptr = &options->hostbased_authentication;
 		goto parse_flag;
@@ -2332,6 +2337,7 @@ initialize_options(Options * options)
 	options->fwd_opts.streamlocal_bind_mask = (mode_t)-1;
 	options->fwd_opts.streamlocal_bind_unlink = -1;
 	options->pubkey_authentication = -1;
+	options->pubkey_disable_pk_check = -1;
 	options->gss_authentication = -1;
 	options->gss_deleg_creds = -1;
 	options->password_authentication = -1;
@@ -2488,6 +2494,8 @@ fill_default_options(Options * options)
 		options->fwd_opts.streamlocal_bind_unlink = 0;
 	if (options->pubkey_authentication == -1)
 		options->pubkey_authentication = 1;
+	if (options->pubkey_disable_pk_check == -1)
+		options->pubkey_disable_pk_check = 0;
 	if (options->gss_authentication == -1)
 		options->gss_authentication = 0;
 	if (options->gss_deleg_creds == -1)
@@ -3285,7 +3293,7 @@ dump_client_config(Options *o, const char *host)
 	dump_cfg_fmtint(oGssDelegateCreds, o->gss_deleg_creds);
 #endif /* GSSAPI */
 	dump_cfg_fmtint(oHashKnownHosts, o->hash_known_hosts);
-	dump_cfg_fmtint(oHostbasedAuthentication, o->hostbased_authentication);
+	dump_cfg_fmtint(oHostbasedAuthentication, o->pubkey_disable_pk_check);
 	dump_cfg_fmtint(oIdentitiesOnly, o->identities_only);
 	dump_cfg_fmtint(oKbdInteractiveAuthentication, o->kbd_interactive_authentication);
 	dump_cfg_fmtint(oNoHostAuthenticationForLocalhost, o->no_host_authentication_for_localhost);
@@ -3293,6 +3301,7 @@ dump_client_config(Options *o, const char *host)
 	dump_cfg_fmtint(oPermitLocalCommand, o->permit_local_command);
 	dump_cfg_fmtint(oProxyUseFdpass, o->proxy_use_fdpass);
 	dump_cfg_fmtint(oPubkeyAuthentication, o->pubkey_authentication);
+	dump_cfg_fmtint(oPubkeyDisablePKCheck, o->pubkey_disable_pk_check);
 	dump_cfg_fmtint(oRequestTTY, o->request_tty);
 	dump_cfg_fmtint(oSessionType, o->session_type);
 	dump_cfg_fmtint(oStdinNull, o->stdin_null);
diff --git a/readconf.h b/readconf.h
index f24719f982..3be7f06361 100644
--- a/readconf.h
+++ b/readconf.h
@@ -37,6 +37,7 @@ typedef struct {
 	char   *xauth_location;	/* Location for xauth program */
 	struct ForwardOptions fwd_opts;	/* forwarding options */
 	int     pubkey_authentication;	/* Try ssh2 pubkey authentication. */
+	int		pubkey_disable_pk_check; /* If true, disables ssh2 pubkey check. */
 	int     hostbased_authentication;	/* ssh2's rhosts_rsa */
 	int     gss_authentication;	/* Try GSS authentication */
 	int     gss_deleg_creds;	/* Delegate GSS credentials */
diff --git a/scp.1 b/scp.1
index 8234ddf90a..2c3493e1c2 100644
--- a/scp.1
+++ b/scp.1
@@ -211,6 +211,7 @@ For full details of the options listed below, and their possible values, see
 .It ProxyJump
 .It PubkeyAcceptedAlgorithms
 .It PubkeyAuthentication
+.It PubkeyDisablePKCheck
 .It RekeyLimit
 .It SendEnv
 .It ServerAliveInterval
diff --git a/sftp.1 b/sftp.1
index 7eebeeacbf..80bc40212a 100644
--- a/sftp.1
+++ b/sftp.1
@@ -270,6 +270,7 @@ For full details of the options listed below, and their possible values, see
 .It ProxyJump
 .It PubkeyAcceptedAlgorithms
 .It PubkeyAuthentication
+.It PubkeyDisablePKCheck
 .It RekeyLimit
 .It SendEnv
 .It ServerAliveInterval
diff --git a/ssh.1 b/ssh.1
index 7efb23828d..6a0ff97f61 100644
--- a/ssh.1
+++ b/ssh.1
@@ -564,6 +564,7 @@ For full details of the options listed below, and their possible values, see
 .It ProxyUseFdpass
 .It PubkeyAcceptedAlgorithms
 .It PubkeyAuthentication
+.It PubkeyDisablePKCheck
 .It RekeyLimit
 .It RemoteCommand
 .It RemoteForward
diff --git a/ssh_config b/ssh_config
index 842ea866c7..2375906610 100644
--- a/ssh_config
+++ b/ssh_config
@@ -24,6 +24,7 @@
 #   HostbasedAuthentication no
 #   GSSAPIAuthentication no
 #   GSSAPIDelegateCredentials no
+#   PubkeyDisablePKCheck no
 #   BatchMode no
 #   CheckHostIP yes
 #   AddressFamily any
diff --git a/ssh_config.5 b/ssh_config.5
index 9d60887e3e..ae614220c9 100644
--- a/ssh_config.5
+++ b/ssh_config.5
@@ -1526,6 +1526,13 @@ The argument to this keyword must be
 (the default)
 or
 .Cm no .
+.It Cm PubkeyDisablePKCheck
+Specifies whether to disable public key lookup on the remote server.
+The argument to this keyword must be
+.Cm no
+(the default)
+or
+.Cm yes .
 .It Cm RekeyLimit
 Specifies the maximum amount of data that may be transmitted before the
 session key is renegotiated, optionally followed by a maximum amount of
diff --git a/sshconnect2.c b/sshconnect2.c
index eff50e3fc8..8b329f6abd 100644
--- a/sshconnect2.c
+++ b/sshconnect2.c
@@ -1849,7 +1849,7 @@ userauth_pubkey(struct ssh *ssh)
 		 * encrypted keys we cannot do this and have to load the
 		 * private key instead
 		 */
-		if (id->key != NULL && !options.identities_only) {
+		if (id->key != NULL && !(options.pubkey_disable_pk_check && options.identities_only)) {
 			if (try_identity(ssh, id)) {
 				ident = format_identity(id);
 				debug("Offering public key: %s", ident);
