parameters:
  - name: buildArtifactsFolder
    type: string
    default: "$(Build.ArtifactStagingDirectory)"

  - name: copyArtifactsToPublishingFolder
    type: boolean
    default: true

  - name: coreRepoRoot
    type: string
    default: "$(Build.SourcesDirectory)"

steps:
  - bash: |
      architecture=$(uname -m)
      raw_toolchain_cache_url="https://cblmarinerstorage.blob.core.windows.net/rawtoolchaincache/toolchain_from_container_2.0.20220709_$architecture.tar.gz"
      raw_toolchain_file_path="${{ parameters.coreRepoRoot }}/build/toolchain/toolchain_from_container.tar.gz"

      # ARM64 hash.
      expected_raw_toolchain_hash="65de43b3bdcfdaac71df1f11fd1f830a8109b1eb9d7cb6cbc2e2d0e929d0ef76"
      if [[ $architecture == "x86_64" ]]; then
          expected_raw_toolchain_hash="f56df34b90915c93f772d3961bf5e9eeb8c1233db43dd92070214e4ce6b72894"
      fi

      echo "-- Downloading cached raw toolchain from '$raw_toolchain_cache_url'."

      mkdir -p "$(dirname "$raw_toolchain_file_path")"
      wget --quiet --timeout=30 --continue "$raw_toolchain_cache_url" -O "$raw_toolchain_file_path"
      if [[ ! -f "$raw_toolchain_file_path" ]]; then
          echo "-- ERROR: failed to download raw toolchain cache." >&2
          return 1
      fi

      # Verifying toolchains SHA-256 hash.
      cache_sha256=$(sha256sum "$raw_toolchain_file_path" | cut -d' ' -f1)
      if [[ "$cache_sha256" != "$expected_raw_toolchain_hash" ]]; then
          echo "-- ERROR: raw toolchain hash verification failed. Expected ($expected_raw_toolchain_hash). Got ($cache_sha256)." >&2
          return 1
      fi
      echo "-- Raw toolchain hash OK."

      touch "$raw_toolchain_file_path"
    displayName: "Populate raw toolchain"

  - bash: sudo make -C "${{ parameters.coreRepoRoot }}/toolkit" "-j$(nproc)" toolchain QUICK_REBUILD=y
    displayName: "Build toolchain"

  - bash: |
      failed_rpms_log="${{ parameters.coreRepoRoot }}/build/logs/toolchain/failures.txt"

      if [[ -f "$failed_rpms_log" ]]; then
          echo "List of RPMs that failed to build:" >&2
          cat "$failed_rpms_log" >&2
      else
          echo "Build failed - no specific RPM" >&2
      fi
    condition: failed()
    displayName: "Print failed RPMs"

  - ${{ if parameters.copyArtifactsToPublishingFolder }}:
    - bash: |
        published_artifacts_dir="${{ parameters.buildArtifactsFolder }}/ARTIFACTS"
        mkdir -p "$published_artifacts_dir"
        cp "${{ parameters.coreRepoRoot }}"/build/toolchain/toolchain_built_{,s}rpms_all.tar.gz "$published_artifacts_dir"
      condition: succeeded()
      displayName: "Copy artifacts for publishing"

    - bash: |
        published_logs_dir="${{ parameters.buildArtifactsFolder }}/LOGS"
        mkdir -p "$published_logs_dir"
        tar -C "${{ parameters.coreRepoRoot }}/build/logs/toolchain" -czf "$published_logs_dir/toolchain.logs.tar.gz" .
      condition: always()
      displayName: "Copy logs for publishing"
